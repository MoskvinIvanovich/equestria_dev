
  end_puppet_this = {
    if = {
      limit = { is_subject = yes }
      overlord = { end_puppet = PREV }
    }
  }
  #PREV to THIS
  transfer_science_ideas = {
    if = {
      limit = { PREV = { has_idea = poor_science_base } }
      add_ideas = poor_science_base
      else = {
        if = {
          limit = { PREV = { has_idea = better_science_base } }
          add_ideas = better_science_base
          else = {
            if = {
              limit = { PREV = { has_idea = big_science_base } }
              add_ideas = big_science_base
            }
          }
        }
      }
    }
  }

  #PREV to THIS
  transfer_society_ideas = {
    if = {
      limit = { PREV = { has_idea = outdated_industry } }
      add_ideas = outdated_industry
      else = {
        if = {
          limit = { PREV = { has_idea = pre_industrial_society } }
          add_ideas = pre_industrial_society
          else = {
            if = {
              limit = { PREV = { has_idea = agrarian_society } }
              add_ideas = agrarian_society
              else = {
                if = {
                  limit = { PREV = { has_idea = tribal_society } }
                  add_ideas = tribal_society
                  else = {
                    if = {
                      limit = { PREV = { has_idea = detached_country } }
                      add_ideas = detached_country
                      else = {
                        if = {
                          limit = { FROM = { has_idea = agrarian_society2 } }
                          add_ideas = agrarian_society2
                          else = {
                            if = {
                              limit = { FROM = { has_idea = agrarian_society3 } }
                              add_ideas = agrarian_society3
                              else = {
                                if = {
                                  limit = { FROM = { has_idea = agrarian_society4 } }
                                  add_ideas = agrarian_society4
                                  else = {
                                    if = {
                                      limit = { FROM = { has_idea = agrarian_society5 } }
                                      add_ideas = agrarian_society5
                                      else = {
                                        if = {
                                          limit = { FROM = { has_idea = agrarian_society6 } }
                                          add_ideas = agrarian_society6
                                          else = {
                                            if = {
                                              limit = { FROM = { has_idea = pre_industrial_society2 } }
                                              add_ideas = pre_industrial_society2
                                              else = {
                                                if = {
                                                  limit = { FROM = { has_idea = pre_industrial_society3 } }
                                                  add_ideas = pre_industrial_society3
                                                  else = {
                                                    if = {
                                                      limit = { FROM = { has_idea = outdated_industry2 } }
                                                      add_ideas = outdated_industry2
                                                    }
                                                  }
                                                }
                                              }
                                            }
                                          }
                                        }
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  }

  # the following effects are excellent for preserving a puppet's government so it doesn't change to the overlord
  # use the first command in the scope of the about-to-be-puppeted country right before the puppet command is executed
  # and then the second, also in the scope of the puppet, right after
  get_current_government_type = {
  	clr_country_flag = was_neutral
  	clr_country_flag = was_communist
  	clr_country_flag = was_democratic
  	clr_country_flag = was_fascist
  	if = {
  		limit = { has_government = neutrality }
  		set_country_flag = was_neutral
  	}
  	if = {
  		limit = { has_government = communism }
  		set_country_flag = was_communist
  	}
  	if = {
  		limit = { has_government = democratic }
  		set_country_flag = was_democratic
  	}
  	if = {
  		limit = { has_government = fascism }
  		set_country_flag = was_fascist
  	}
  }

  restore_previous_government_type = {
  	hidden_effect = {
  		if = {
  			limit = { has_country_flag = was_neutral }
  			set_politics = { ruling_party = neutrality }
        add_popularity = { ideology = neutrality popularity = 0.5 }
  		}
  		if = {
  			limit = { has_country_flag = was_communist }
  			set_politics = { ruling_party = communism }
        add_popularity = { ideology = communism popularity = 0.5 }
  		}
  		if = {
  			limit = { has_country_flag = was_democratic }
  			set_politics = { ruling_party = democratic }
        add_popularity = { ideology = democratic popularity = 0.5 }
  		}
  		if = {
  			limit = { has_country_flag = was_fascist }
  			set_politics = { ruling_party = fascism }
        add_popularity = { ideology = fascism popularity = 0.5 }
  		}
  	}
  }

  get_current_autonomy_level = {
    hidden_effect = {
      clr_country_flag = former_integrated_puppet
      clr_country_flag = former_puppet
      clr_country_flag = former_colony
      clr_country_flag = former_dominion
      if = {
        limit = { has_autonomy_state = autonomy_integrated_puppet }
        set_country_flag = former_integrated_puppet
        else = {
          if = {
            limit = { has_autonomy_state = autonomy_puppet }
            set_country_flag = former_puppet
            else = {
              if = {
                limit = { has_autonomy_state = autonomy_colony }
                set_country_flag = former_colony
                if = {
                  limit = { has_autonomy_state = autonomy_dominion }
                  set_country_flag = former_dominion
                }
              }
            }
          }
        }
      }
    }
  }

  set_previous_autonomy_level = {
    hidden_effect = {
     if = {
       limit = { has_dlc = "Together for Victory" }
       if = {
         limit = { has_country_flag = former_integrated_puppet }
         add_autonomy_ratio = { value = -0.15 }
         overlord = {
           if = {
             limit = { has_government = fascism }
             set_autonomy = { target = FROM autonomy_state = autonomy_reichskommissariat }
             else = {
               set_autonomy = { target = FROM autonomy_state = autonomy_integrated_puppet }
             }
           }
         }
         else = {
           if = {
             limit = { has_country_flag = former_colony }
             add_autonomy_ratio = { value = 0.55 }
             overlord = {
               if = {
                 limit = { has_government = fascism }
                 set_autonomy = { target = FROM autonomy_state = autonomy_reichsprotectorate }
                 else = {
                   set_autonomy = { target = FROM autonomy_state = autonomy_colony }
                 }
               }
             }
             else = {
               if = {
                 limit = { has_country_flag = former_dominion }
                 add_autonomy_ratio = { value = 0.80 }
                 overlord = {
                   if = {
                     limit = { has_government = fascism }
                     set_autonomy = { target = FROM autonomy_state = autonomy_satellite }
                     else = {
                       set_autonomy = { target = FROM autonomy_state = autonomy_dominion }
                     }
                   }
                 }
               }
             }
           }
         }
       }
     }
    }
  }

Evil_unicorn_magic = {
	if = {
		limit = {
			PREV = {
				has_tech = tech_unicorn_th
			}
		}
		if = {
			limit = {
				has_government = fascism
			}
			set_technology = {
				tech_unicorn_ms = 1
        tech_unicorn_th = 0
			}
			else = {
				set_technology = {
					tech_unicorn_th = 1
				}
			}
		}
	}

	if = {
		limit = {
			PREV = {
				has_tech = tech_unicorn_th2
			}
		}
		if = {
			limit = {
				has_government = fascism
			}
			set_technology = {
				tech_unicorn_ms2 = 1
        tech_unicorn_th2 = 0
			}
			else = {
				set_technology = {
					tech_unicorn_th2 = 1
				}
			}
		}
	}

	if = {
		limit = {
			PREV = {
				has_tech = tech_unicorn_th3
			}
		}
		if = {
			limit = {
				has_government = fascism
			}
			set_technology = {
				tech_unicorn_ms3 = 1
        tech_unicorn_th3 = 0
			}
			else = {
				set_technology = {
					tech_unicorn_th3 = 1
				}
			}
		}
	}

	if = {
		limit = {
			PREV = {
				has_tech = tech_unicorn_th4
			}
		}
		if = {
			limit = {
				has_government = fascism
			}
			set_technology = {
				tech_unicorn_ms4 = 1
        tech_unicorn_th4 = 0
			}
			else = {
				set_technology = {
					tech_unicorn_th4 = 1
				}
			}
		}
	}

	if = {
		limit = {
			PREV = {
				has_tech = tech_unicorn_th5
			}
		}
		if = {
			limit = {
				has_government = fascism
			}
			set_technology = {
				tech_unicorn_ms5 = 1
        tech_unicorn_th5 = 0
			}
			else = {
				set_technology = {
					tech_unicorn_th5 = 1
				}
			}
		}
	}
}
